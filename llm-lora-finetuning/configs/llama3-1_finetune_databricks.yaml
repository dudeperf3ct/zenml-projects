# Apache Software License 2.0
# 
# Copyright (c) ZenML GmbH 2024. All rights reserved.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# 

model:
  name: llm-peft-llama-3-1
  description: "Fine-tune `llama-3.1`."
  tags:
    - llm
    - peft
    - lora
    - llama-3.1
    - remote
    - ai-medical-chatbot
  version: 300_steps

settings:
  docker:
    parent_image: pytorch/pytorch:2.2.2-cuda11.8-cudnn8-runtime
    requirements: requirements.txt
    python_package_installer: uv
    python_package_installer_args:
      system: null
    apt_packages: 
      - git
    environment:
      PJRT_DEVICE: CUDA
      USE_TORCH_XLA: "false"
      MKL_SERVICE_FORCE_INTEL: "1"
      MLFLOW_ENABLE_SYSTEM_METRICS_LOGGING: "true"
  orchestrator.databricks:
    spark_version : 15.3.x-gpu-ml-scala2.12
    node_type_id : Standard_NC24ads_A100_v4

parameters:
  base_model_id: meta-llama/Meta-Llama-3.1-8B
  use_fast: False
  load_in_8bit: True
  system_prompt: |
    You are an AI Medical Assistant trained on a vast dataset of health information. Please be thorough and provide an informative answer. If you don't know the answer to a specific medical inquiry, advise seeking professional help.
    

steps:
  prepare_data:
    parameters:
      dataset_name: ruslanmv/ai-medical-chatbot

  finetune:
    retry:
      max_retries: 3
      delay: 10
      backoff: 2
    parameters:
      max_steps: 300
      eval_steps: 30
      bf16: True

  evaluate_finetuned:
    retry:
      max_retries: 3
      delay: 10
      backoff: 2

  evaluate_base:
    retry:
      max_retries: 3
      delay: 10
      backoff: 2

  promote:
    parameters:
      metric: rouge2
      target_stage: staging

  merge_adapter_base_model:
    parameters:
      model_name: llm-peft-llama-3-1

  track_log_model:
    retry:
      max_retries: 3
      delay: 10
      backoff: 2
    parameters:
      model_name: llm-peft-llama-3-1